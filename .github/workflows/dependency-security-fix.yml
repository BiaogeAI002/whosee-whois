name: ğŸ”’ æ‰‹åŠ¨å®‰å…¨ä¾èµ–ä¿®å¤

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'ä¿®å¤ç±»å‹'
        required: true
        default: 'non-breaking'
        type: choice
        options:
        - 'non-breaking'
        - 'force-fix'
        - 'audit-only'

jobs:
  security-audit:
    name: å®‰å…¨å®¡è®¡å’Œä¿®å¤
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“Š å‰ç«¯ä¾èµ–å®¡è®¡
      run: |
        echo "ğŸ” æ£€æŸ¥å‰ç«¯ä¾èµ–å®‰å…¨çŠ¶å†µ..."
        npm audit --audit-level=moderate || true
        echo "ğŸ“‹ ç”Ÿæˆå®¡è®¡æŠ¥å‘Š..."
        npm audit --json > frontend-audit.json || true

    - name: ğŸ“Š CMS ä¾èµ–å®¡è®¡
      run: |
        echo "ğŸ” æ£€æŸ¥ CMS ä¾èµ–å®‰å…¨çŠ¶å†µ..."
        cd cms
        npm audit --audit-level=moderate || true
        echo "ğŸ“‹ ç”Ÿæˆ CMS å®¡è®¡æŠ¥å‘Š..."
        npm audit --json > cms-audit.json || true

    - name: ğŸ”§ å®‰å…¨ä¿®å¤ (éç ´åæ€§)
      if: github.event.inputs.fix_type == 'non-breaking'
      run: |
        echo "ğŸ”§ å°è¯•éç ´åæ€§å®‰å…¨ä¿®å¤..."
        npm audit fix --audit-level=moderate --force=false || true
        cd cms
        npm audit fix --audit-level=moderate --force=false || true

    - name: âš¡ å¼ºåˆ¶å®‰å…¨ä¿®å¤
      if: github.event.inputs.fix_type == 'force-fix'
      run: |
        echo "âš¡ æ‰§è¡Œå¼ºåˆ¶å®‰å…¨ä¿®å¤ï¼ˆå¯èƒ½åŒ…å«ç ´åæ€§å˜æ›´ï¼‰..."
        echo "âš ï¸ è­¦å‘Šï¼šè¿™å¯èƒ½å¯¼è‡´ç ´åæ€§å˜æ›´ï¼"
        npm audit fix --force || true
        cd cms
        npm audit fix --force || true

    - name: ğŸ“ åˆ›å»ºå®‰å…¨æŠ¥å‘Š
      run: |
        echo "ğŸ“ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."
        cat > security-report.md << 'EOF'
        # ğŸ”’ å®‰å…¨ä¾èµ–å®¡è®¡æŠ¥å‘Š
        
        ## ğŸ“Š å®¡è®¡æ—¶é—´
        $(date)
        
        ## ğŸ¯ ä¿®å¤ç±»å‹
        ${{ github.event.inputs.fix_type }}
        
        ## ğŸ“‹ å‰ç«¯ä¾èµ–çŠ¶å†µ
        ```
        $(npm audit --audit-level=moderate 2>&1 || echo "å®¡è®¡å®Œæˆ")
        ```
        
        ## ğŸ“‹ CMS ä¾èµ–çŠ¶å†µ
        ```
        $(cd cms && npm audit --audit-level=moderate 2>&1 || echo "å®¡è®¡å®Œæˆ")
        ```
        
        ## ğŸ”§ å»ºè®®æ“ä½œ
        
        ### å¯¹äº esbuild æ¼æ´ï¼š
        - å½“å‰ç‰ˆæœ¬å—é™äº Strapi 5.18.0 çš„ä¾èµ–è¦æ±‚
        - å»ºè®®ç­‰å¾… Strapi æ›´æ–°æ”¯æŒ esbuild@0.25.0+
        - ä¸´æ—¶ç¼“è§£ï¼šå¼€å‘ç¯å¢ƒä¸­é™åˆ¶ç½‘ç»œè®¿é—®
        
        ### å¯¹äº koa æ¼æ´ï¼š
        - å½±å“ï¼šå¼€æ”¾é‡å®šå‘ï¼ˆä¸­ç­‰ä¸¥é‡æ€§ï¼‰
        - å»ºè®®ï¼šå‡çº§åˆ° koa@2.17.0+
        
        ### å¯¹äº tmp æ¼æ´ï¼š
        - å½±å“ï¼šç¬¦å·é“¾æ¥å†™å…¥ï¼ˆä¸­ç­‰ä¸¥é‡æ€§ï¼‰
        - å»ºè®®ï¼šå‡çº§ç›¸å…³ä¾èµ–
        
        ## ğŸ“ˆ åç»­è·Ÿè¸ª
        - [ ] ç›‘æ§ Strapi 5.19+ ç‰ˆæœ¬å‘å¸ƒ
        - [ ] å®šæœŸæ£€æŸ¥å®‰å…¨æ›´æ–°
        - [ ] è€ƒè™‘ä½¿ç”¨ npm overrides ä¸´æ—¶è§£å†³ç‰ˆæœ¬å†²çª
        EOF

    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: |
          security-report.md
          frontend-audit.json
          cms-audit.json
        retention-days: 30

    - name: ğŸ’¬ è¯„è®º PR (å¦‚æœæœ‰å˜æ›´)
      if: github.event.inputs.fix_type != 'audit-only'
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡åˆ›å»º PR..."
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          git status --short
        else
          echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi

    - name: ğŸ”’ è®¾ç½®å®‰å…¨åˆ†æ”¯ä¿æŠ¤
      if: github.event.inputs.fix_type == 'force-fix'
      run: |
        echo "âš ï¸ å¼ºåˆ¶ä¿®å¤å¯èƒ½å¼•å…¥ç ´åæ€§å˜æ›´"
        echo "ğŸ” å»ºè®®åœ¨åˆå¹¶å‰è¿›è¡Œå®Œæ•´æµ‹è¯•"
        echo "ğŸ“‹ æµ‹è¯•æ¸…å•ï¼š"
        echo "- [ ] CMS å¯åŠ¨æµ‹è¯•"
        echo "- [ ] å‰ç«¯æ„å»ºæµ‹è¯•"
        echo "- [ ] åŠŸèƒ½é›†æˆæµ‹è¯•"
